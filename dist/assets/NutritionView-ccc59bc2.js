import{d as U,g,f as I,j as W,c as i,a as e,k as G,v as J,z as X,t as n,m as p,F as b,x as h,e as S,n as w,A as z,_ as Y,o as r}from"./index-3dc22b18.js";import{s as Z,g as ee}from"./api-9ba1db73.js";import{_ as se}from"./_plugin-vue_export-helper-c27b6911.js";const te={class:"nutrition-view"},ae={class:"search-section"},le={class:"search-box"},ne=["disabled"],oe={key:0,class:"ai-search-status"},ie={key:1,class:"milk-tea-selection"},re={class:"results-grid"},ue=["onClick"],ce={class:"tea-info"},de={class:"tea-price-small"},ve={key:2,class:"selected-tea"},ge={class:"tea-header"},pe={class:"tea-meta"},fe={class:"tea-price"},_e={key:0,class:"error-message"},me={key:0,class:"tea-introduction-card"},be={class:"tea-intro-content"},he={class:"intro-header"},ye={class:"intro-title"},ke={class:"intro-brand"},we={class:"intro-description"},xe={key:0,class:"intro-ingredients"},Ie={key:1,class:"intro-features"},Ae={class:"customization"},Ce={class:"custom-options"},Te={class:"option-group"},Se={class:"option-buttons"},Me=["onClick"],Pe={class:"option-group"},ze={class:"option-buttons"},Ne=["onClick"],$e={class:"option-group"},Fe={class:"option-buttons"},Ee=["onClick"],De={class:"nutrition-info"},Ve={class:"nutrition-stats"},Le={class:"nutrition-stat"},Be={class:"stat-value"},Ke={class:"nutrition-stat"},Oe={class:"stat-value"},Re={class:"nutrition-stat"},je={class:"stat-value"},qe={class:"nutrition-stat"},He={class:"stat-value"},Qe={class:"daily-percentage"},Ue={class:"percentage-bars"},We={class:"percentage-item"},Ge={class:"percentage-bar-container"},Je={class:"percentage-item"},Xe={class:"percentage-bar-container"},Ye={class:"percentage-item"},Ze={class:"percentage-bar-container"},es={class:"health-tips"},ss={key:0,class:"tips-container"},ts={class:"tip-icon"},as={class:"tip-content"},ls={key:1,class:"loading-tips"},ns={key:2,class:"ai-tags"},os={key:3,class:"error-message"},is={key:3,class:"empty-state"},rs=U({__name:"NutritionView",setup(us){const M=[{value:0,label:"无糖",factor:0},{value:30,label:"微糖",factor:.3},{value:50,label:"半糖",factor:.5},{value:70,label:"少糖",factor:.7},{value:100,label:"全糖",factor:1}],B=[{value:0,label:"热饮"},{value:30,label:"微冰"},{value:50,label:"少冰"},{value:100,label:"正常冰"}],N=[{value:"super_large",label:"超大杯"},{value:"large",label:"大杯"},{value:"medium",label:"中杯"}],m=g(""),x=g([]),a=g(null),f=g(100),A=g(100),v=g("medium"),y=g(!1);async function $(){if(!(!m.value.trim()||y.value)){y.value=!0,x.value=[],_.value="";try{console.log("开始AI搜索奶茶信息:",m.value);const l=await Z(m.value);l.success&&l.data?(x.value=[l.data],console.log("AI搜索成功，获取到奶茶信息:",l.data)):(_.value=l.error||"搜索失败，请尝试其他关键词",console.error("AI搜索失败:",l.error))}catch(l){console.error("AI搜索奶茶失败:",l),_.value="搜索失败: "+(l instanceof Error?l.message:String(l))}finally{y.value=!1}}}function K(l){a.value=l,f.value=100,A.value=100,v.value="medium",k.value=[],setTimeout(()=>{E()},500)}const O=I(()=>{if(!a.value)return 0;let l=a.value.price;return v.value==="super_large"?l+=8:v.value==="large"&&(l+=4),parseFloat(l.toFixed(1))});W([f,A,v],()=>{a.value&&(P&&clearTimeout(P),P=setTimeout(()=>{E()},500))});let P=null;const u=I(()=>{var L;if(!a.value)return{calories:0,sugar:0,fat:0,caffeine:0,caloriesPercentage:0,sugarPercentage:0};const l=((L=M.find(Q=>Q.value===f.value))==null?void 0:L.factor)||1;let s=1;v.value==="super_large"?s=1.5:v.value==="large"&&(s=1.3),console.log("计算调试:",{sweetness:f.value,sweetnessFactor:l,cupSize:v.value,sizeFactor:s,baseSugar:a.value.baseSugar,calculatedSugar:Number(a.value.baseSugar)*l*s});let o=Number(a.value.baseCalories)||0;o=Math.round(o*s);let c=0;f.value===0?(c=0,o=Math.round(o*.9)):c=Number(a.value.baseSugar)*l*s;let t=Number(a.value.baseFat)||0;t=t*s;let d=Number(a.value.baseCaffeine)||0;d=Math.round(d*s);const V=Math.round(o/2e3*100),H=Math.round(c/25*100);return{calories:Math.round(o),sugar:Math.round(c*10)/10,fat:Math.round(t*10)/10,caffeine:Math.round(d),caloriesPercentage:V,sugarPercentage:H}});I(()=>[]);const k=g([]),C=g(!1);g(!1);const _=g(""),R=I(()=>F.value.length===0),F=I(()=>k.value);async function E(){var l;if(!(C.value||!a.value)){C.value=!0,_.value="",k.value=[];try{console.log("开始营养分析...");const s=((l=M.find(t=>t.value===f.value))==null?void 0:l.label)||"全糖",o={calories:u.value.calories,sugar:u.value.sugar,fat:u.value.fat,caffeine:u.value.caffeine,caloriesPercentage:u.value.caloriesPercentage,sugarPercentage:u.value.sugarPercentage},c={name:a.value.name,brand:a.value.brand,size:a.value.size,sweetness:f.value,cupSize:v.value,toppings:[],nutrition:o};console.log("准备发送的数据:",c),await ee(c,()=>{console.log("开始流式分析..."),k.value=[]},t=>{console.log("收到新提示:",t),t&&t.trim()&&k.value.push(t.trim())},t=>{console.log("分析完成，共",t.length,"条提示")},t=>{console.error("营养分析失败:",t),_.value="分析请求失败: "+t})}catch(s){console.error("营养分析失败:",s),_.value="分析请求失败，请稍后再试"}finally{C.value=!1}}}function j(l){const s=["💡","🍵","🥗","⏰","👨‍👩‍👧‍👦","❤️","🏃‍♂️"];return s[l%s.length]}const T=g("");async function D(){var s;if(!a.value)return;T.value="";const l=q("正在添加到账单...");try{const{addBill:o}=await Y(()=>import("./billApi-aeb160ca.js"),[]),c={date:new Date().toISOString().split("T")[0],brand:a.value.brand||"未知品牌",name:a.value.name||"未知产品",size:a.value.size||"标准",price:parseFloat(a.value.price)||0,calories:parseInt(u.value.calories)||0,sugar:parseFloat(u.value.sugar)||0,fat:parseFloat(u.value.fat)||0,caffeine:parseInt(u.value.caffeine)||0,cupSize:v.value};console.log("准备添加账单数据:",c);const t=await o(c);l&&l.close(),alert(`已成功将 ${a.value.brand} ${a.value.name} 添加到账单！`),console.log("添加到账单成功:",t)}catch(o){l&&l.close(),console.error("添加到账单失败:",o);let c="服务器连接异常";o.response?(c=`服务器错误 (${o.response.status}): ${((s=o.response.data)==null?void 0:s.message)||o.response.statusText}`,console.error("服务器返回的错误数据:",o.response.data)):o.request?c="未收到服务器响应，请检查网络连接":c=o.message||"未知错误",T.value=`添加到账单失败: ${c}`}}function q(l){const s=document.createElement("div");s.className="loading-toast",s.innerHTML=`
    <div class="loading-spinner"></div>
    <div class="loading-message">${l}</div>
  `;const o=document.createElement("style");return o.textContent=`
    .loading-toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 9999;
    }
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid white;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-message {
      font-size: 14px;
    }
  `,document.head.appendChild(o),document.body.appendChild(s),{close:()=>{document.body.removeChild(s)}}}return(l,s)=>{var o,c;return r(),i("div",te,[s[27]||(s[27]=e("h1",null,"营养分析",-1)),e("div",ae,[e("div",le,[G(e("input",{type:"text","onUpdate:modelValue":s[0]||(s[0]=t=>m.value=t),placeholder:"输入任意奶茶名称，使用AI搜索...",onKeyup:X($,["enter"])},null,544),[[J,m.value]]),e("button",{class:"btn-ai-search",onClick:$,disabled:y.value||!m.value.trim()},n(y.value?"AI搜索中...":"AI智能搜索"),9,ne)])]),y.value?(r(),i("div",oe,[s[1]||(s[1]=e("div",{class:"loading-spinner"},null,-1)),e("p",null,'AI正在搜索"'+n(m.value)+'"的营养信息，请稍候...',1)])):p("",!0),x.value.length>0?(r(),i("div",ie,[s[3]||(s[3]=e("h2",null,"搜索结果",-1)),e("div",re,[(r(!0),i(b,null,h(x.value,(t,d)=>(r(),i("div",{key:d,class:"tea-card",onClick:V=>K(t)},[s[2]||(s[2]=e("div",{class:"tea-icon"},"🥤",-1)),e("div",ce,[e("h3",null,n(t.name),1),e("p",null,[S(n(t.brand)+" | "+n(t.size)+" | ",1),e("span",de,"¥"+n(t.price),1)])])],8,ue))),128))])])):p("",!0),a.value?(r(),i("div",ve,[e("div",ge,[e("h2",null,n(a.value.name),1),e("div",pe,[e("span",null,n(a.value.brand),1),e("span",null,n(((o=N.find(t=>t.value===v.value))==null?void 0:o.label)||"中杯"),1),e("span",fe,"¥"+n(O.value),1),s[4]||(s[4]=e("span",{class:"ai-generated-badge"},"AI分析",-1))]),e("button",{class:"btn-add-to-bill",onClick:D,title:"添加到账单"},"添加到账单"),T.value?(r(),i("div",_e,[s[6]||(s[6]=e("i",null,"⚠️",-1)),S(" "+n(T.value)+" ",1),e("div",{class:"error-actions"},[e("button",{class:"error-retry",onClick:D},"重试"),s[5]||(s[5]=e("span",{class:"error-hint"},"如果问题持续存在，请检查网络连接或联系管理员",-1))])])):p("",!0)]),a.value&&a.value.introduction?(r(),i("div",me,[s[9]||(s[9]=e("h3",null,"产品详情",-1)),e("div",be,[e("div",he,[s[7]||(s[7]=e("div",{class:"intro-icon"},"🍵",-1)),e("div",ye,[e("h4",null,n(a.value.name),1),e("span",ke,n(a.value.brand),1)])]),e("div",we,[e("p",null,n(a.value.introduction.summary),1),a.value.introduction.ingredients&&a.value.introduction.ingredients.length>0?(r(),i("ul",xe,[(r(!0),i(b,null,h(a.value.introduction.ingredients,(t,d)=>(r(),i("li",{key:"ing-"+d},[e("strong",null,n(t.name)+"：",1),S(n(t.description),1)]))),128))])):p("",!0),s[8]||(s[8]=e("h5",null,"产品特点",-1)),a.value.introduction.features&&a.value.introduction.features.length>0?(r(),i("ul",Ie,[(r(!0),i(b,null,h(a.value.introduction.features,(t,d)=>(r(),i("li",{key:"feat-"+d},[e("strong",null,n(t.title)+"：",1),S(n(t.description),1)]))),128))])):p("",!0)])])])):p("",!0),e("div",Ae,[s[13]||(s[13]=e("h3",null,"定制你的奶茶",-1)),e("div",Ce,[e("div",Te,[s[10]||(s[10]=e("label",null,"甜度",-1)),e("div",Se,[(r(),i(b,null,h(M,t=>e("button",{key:t.value,class:w(["custom-btn",f.value===t.value?"active":""]),onClick:d=>f.value=t.value},n(t.label),11,Me)),64))])]),e("div",Pe,[s[11]||(s[11]=e("label",null,"冰量",-1)),e("div",ze,[(r(),i(b,null,h(B,t=>e("button",{key:t.value,class:w(["custom-btn",A.value===t.value?"active":""]),onClick:d=>A.value=t.value},n(t.label),11,Ne)),64))])]),e("div",$e,[s[12]||(s[12]=e("label",null,"杯型大小",-1)),e("div",Fe,[(r(),i(b,null,h(N,t=>e("button",{key:t.value,class:w(["custom-btn",v.value===t.value?"active":""]),onClick:d=>v.value=t.value},n(t.label),11,Ee)),64))])])])]),e("div",De,[s[22]||(s[22]=e("h3",null,"营养成分",-1)),e("div",Ve,[e("div",Le,[e("div",Be,n(u.value.calories),1),s[14]||(s[14]=e("div",{class:"stat-label"},"卡路里",-1))]),e("div",Ke,[e("div",Oe,n(u.value.sugar)+"g",1),s[15]||(s[15]=e("div",{class:"stat-label"},"糖分",-1))]),e("div",Re,[e("div",je,n(u.value.fat)+"g",1),s[16]||(s[16]=e("div",{class:"stat-label"},"脂肪",-1))]),e("div",qe,[e("div",He,n(u.value.caffeine)+"mg",1),s[17]||(s[17]=e("div",{class:"stat-label"},"咖啡因",-1))])]),e("div",Qe,[s[21]||(s[21]=e("h4",null,"占每日推荐摄入量百分比",-1)),e("div",Ue,[e("div",We,[s[18]||(s[18]=e("div",{class:"percentage-label"},"卡路里",-1)),e("div",Ge,[e("div",{class:w(["percentage-bar",{warning:u.value.caloriesPercentage>30}]),style:z({width:`${u.value.caloriesPercentage}%`})},null,6),e("span",null,n(u.value.caloriesPercentage)+"%",1)])]),e("div",Je,[s[19]||(s[19]=e("div",{class:"percentage-label"},"糖分",-1)),e("div",Xe,[e("div",{class:w(["percentage-bar",{warning:u.value.sugarPercentage>30}]),style:z({width:`${u.value.sugarPercentage}%`})},null,6),e("span",null,n(u.value.sugarPercentage)+"%",1)])]),e("div",Ye,[s[20]||(s[20]=e("div",{class:"percentage-label"},"咖啡因",-1)),e("div",Ze,[e("div",{class:w(["percentage-bar",{warning:u.value.caffeine>200}]),style:z({width:`${Math.min(100,Math.round(u.value.caffeine/400*100))}%`})},null,6),e("span",null,n(Math.min(100,Math.round(u.value.caffeine/400*100)))+"%",1)])])])])]),e("div",es,[s[25]||(s[25]=e("h3",null,"健康小贴士",-1)),R.value?p("",!0):(r(),i("div",ss,[(r(!0),i(b,null,h(F.value,(t,d)=>(r(),i("div",{class:"tip",key:d},[e("div",ts,n(j(d)),1),e("div",as,n(t),1)]))),128))])),C.value?(r(),i("div",ls,[s[23]||(s[23]=e("div",{class:"loading-spinner"},null,-1)),e("p",null,'正在分析"'+n((c=a.value)==null?void 0:c.name)+'"，请稍候...',1)])):p("",!0),k.value.length>0?(r(),i("div",ns,s[24]||(s[24]=[e("span",{class:"ai-tag"},"AI生成",-1),e("span",{class:"ai-tag"},"基于DeepSeek AI",-1)]))):p("",!0),_.value?(r(),i("div",os,[e("p",null,n(_.value),1)])):p("",!0)])])):p("",!0),!a.value&&x.value.length===0?(r(),i("div",is,s[26]||(s[26]=[e("div",{class:"empty-icon"},"🔍",-1),e("h2",null,"AI智能奶茶营养分析",-1),e("p",null,"输入任意奶茶名称，使用AI智能分析其营养成分",-1),e("p",null,'例如：尝试搜索"芝芝莓莓"、"霸气芝士芒芒"或"椰椰奶冻"等',-1)]))):p("",!0)])}}});const gs=se(rs,[["__scopeId","data-v-b215d976"]]);export{gs as default};
